# RAG System

## Описание проекта

RAG System — это система поиска и генерации ответов на основе документов (PDF) с использованием Retrieval-Augmented Generation (RAG). Система использует гибридный RAG (BM25 + dense retriever на OpenAI embeddings/ChromaDB) для повышения качества поиска. Система поддерживает интеграцию с Telegram-ботом для интерактивного взаимодействия и с Google Drive для автоматической синхронизации и хранения документов.

## Основные возможности

- Загрузка и индексация PDF-документов
- Поиск и генерация ответов на вопросы пользователей по содержимому документов
- Интеграция с Telegram-ботом для диалога и загрузки файлов
- Автоматическая синхронизация документов с Google Drive
- Автоматический подбор параметров чанкинга с помощью autotune. Система анализирует документы, подбирает оптимальные значения chunk_size и chunk_overlap, а в логах можно отслеживать метрики recall и top-k ("количество возвращаемых фрагментов").
- Логирование и мониторинг процессов

## Краткосрочная память сессии (In-Memory Session)

Система поддерживает краткосрочную память для каждого пользователя в рамках одной сессии. Для этого используется in-memory хранилище Redis:
- История сообщений пользователя и другие временные данные сохраняются в Redis с автоматическим очищением (TTL по умолчанию 30 минут).
- Это позволяет боту помнить контекст диалога и обеспечивать быстрый доступ к сессионным данным.
- Redis запускается автоматически через docker-compose, отдельная настройка не требуется.
- Параметры подключения к Redis задаются через переменные окружения `REDIS_HOST` и `REDIS_PORT` (по умолчанию используются значения для docker-compose).

Модуль управления сессиями реализован в `src/utils/session_manager.py` и может быть расширен под любые задачи хранения временных пользовательских данных.

## Установка и настройка

1. **Клонируйте репозиторий:**
   ```bash
   git clone <URL-ВАШЕГО-РЕПОЗИТОРИЯ>
   cd RAG_system
   ```
2. **Создайте и активируйте виртуальное окружение:**
   ```bash
   python -m venv venv
   source venv/bin/activate  # для Linux/Mac
   venv\Scripts\activate   # для Windows
   ```
3. **Установите зависимости:**
   ```bash
   pip install -r requirements.txt
   ```
4. **Скопируйте и настройте переменные окружения:**
   ```bash
   cp env.example .env
   # Отредактируйте .env, добавьте свои ключи и токены
   ```
5. **Настройте файл конфигурации:**
   - Отредактируйте `config.yaml` под свои нужды (модели, параметры поиска, пути к папкам и т.д.)

## Переменные окружения и конфиг

Минимальный набор переменных окружения:
- `OPENAI_API_KEY` — ключ OpenAI для генерации эмбеддингов и ответов
- `TELEGRAM_BOT_TOKEN` — токен Telegram-бота
- `GOOGLE_DRIVE_FOLDER_ID` — ID папки Google Drive для синхронизации
- (опционально) `LOG_LEVEL`, `LOG_FILE`, другие параметры см. в `env.example`


## Быстрый старт (Telegram)

1. Запустите Telegram-бота:
   ```bash
   python -m src.bot.telegram_bot
   ```
2. В Telegram найдите своего бота и отправьте PDF-файл или вопрос по ранее загруженным документам.
3. Бот автоматически загрузит файл в Google Drive, проиндексирует его и будет готов отвечать на вопросы по содержимому.

## Запуск в Docker

1. Соберите и запустите контейнер с помощью docker-compose:
   ```bash
   docker-compose up --build
   ```
   Контейнер автоматически установит зависимости, скопирует исходный код и запустит Telegram-бота.

2. Для настройки переменных окружения используйте файл `env.example` (или создайте `.env` на его основе). Все переменные будут автоматически подхвачены контейнером.

3. Для хранения индексов и базы ChromaDB используется volume `./chroma_db` (он монтируется внутрь контейнера).

4. Остановить контейнер можно командой:
   ```bash
   docker-compose down
   ```

5. При необходимости можно запускать контейнер вручную:
   ```bash
   docker build -t rag_system .
   docker run --env-file env.example -v $(pwd)/chroma_db:/app/chroma_db rag_system
   ```

## Интеграция с Google Drive

- Для работы с Google Drive требуется создать OAuth-клиент в Google Cloud и скачать файл `client_secrets.json`.
- При первом запуске потребуется пройти авторизацию.
- Все загруженные через Telegram файлы автоматически попадают в Google Drive и индексируются.
- Система поддерживает автоматическую синхронизацию новых и удалённых файлов из Google Drive.

## Примеры использования

### Через Telegram
- Отправьте PDF-файл боту — он будет проиндексирован и добавлен в базу знаний.
- Задайте вопрос по содержимому документов — бот найдёт релевантные фрагменты и сгенерирует ответ.

### Через Python API (CLI)
```python
from src.core.rag_system_instance import get_rag_system
rag = get_rag_system()
# Индексация файла
rag.ingest_file('path/to/file.pdf')
# Поиск ответа
answer = rag.query('В чем суть документа?')
print(answer)
```

## Структура проекта

```
RAG_system/
├── src/
│   ├── core/         # Ядро системы, бизнес-логика, конфиг
│   ├── utils/        # Вспомогательные утилиты (логгер, pdf, autotune)
│   ├── bot/          # Telegram-бот
│   └── sources/      # Интеграция с Google Drive и другими источниками
├── config.yaml       # Основной конфиг системы
├── env.example       # Пример переменных окружения
├── requirements.txt  # Зависимости
└── README.md         # Документация
```

